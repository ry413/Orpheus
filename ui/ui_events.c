// This file was generated by SquareLine Studio
// SquareLine Studio version: SquareLine Studio 1.4.0
// LVGL version: 8.3.6
// Project name: SquareLine_Project

#include "ui.h"
#include <stdio.h>
#include <time.h>
#include <esp_log.h>
#include <freertos/FreeRTOS.h>
#include <freertos/task.h>
#include <freertos/portmacro.h>
#include <esp_sntp.h>

#include "wifi.h"


//////////////////// STATIC FUNCTION DECLARATIONS ////////////////////
static void updateCurrentTimeLabel();
static void obtainTime(void* pvParameter);
static void updateTimeTask(void *pvParameter);

// 全局变量用于存储日月时分的时间戳
time_t globalTime = 0;
lv_obj_t * currentTimeLabel;

// 时间更新定时器
static void updateTimeTask(void *pvParameter)
{
    while (1)
    {
        updateCurrentTimeLabel();
        vTaskDelay(1000 / portTICK_PERIOD_MS);
        globalTime += 1;
    }
}
// 除了被定时器调用外，在每个screen loaded时也会调用
static void updateCurrentTimeLabel() {
    struct tm timeinfo;
    char timeStr[9];

    localtime_r(&globalTime, &timeinfo);
    strftime(timeStr, sizeof(timeStr), "%H:%M:%S", &timeinfo);
    lv_label_set_text(currentTimeLabel, timeStr);
}
// 获取时间
static void obtainTime(void* pvParameter)
{
    // NTP服务器列表, 这是macOS上使用ntpdate测试出的一些延迟低的服务器
    const char* ntp_servers[] = {
        "cn.ntp.org.cn",
        "edu.ntp.org.cn",
        "ntp.sjtu.edu.cn",
        "ntp.aliyun.com",
        "pool.ntp.org",
    };
    const int num_ntp_servers = sizeof(ntp_servers) / sizeof(ntp_servers[0]);

    time_t now = 0;
    struct tm timeinfo = { 0 };
    int retry = 0;
    const int retry_count = 10;

    esp_sntp_setoperatingmode(SNTP_OPMODE_POLL);
    for (int i = 0; i < num_ntp_servers; ++i) {
        esp_sntp_setservername(i, ntp_servers[i]);
    }
    esp_sntp_init();

    while (timeinfo.tm_year < (2016 - 1900) && ++retry < retry_count) {
        ESP_LOGI("obtainTime", "等待系统时间设置... (%d/%d) 正在尝试连接服务器: %s", retry, retry_count, ntp_servers[retry % num_ntp_servers]);

        vTaskDelay(2000 / portTICK_PERIOD_MS);
        time(&now);
        localtime_r(&now, &timeinfo);
    }

    if (retry >= retry_count) {
        ESP_LOGE("obtainTime", "在 %d 次重试后无法获取时间。请检查您的网络连接。", retry_count);
    } else {
        ESP_LOGI("obtainTime", "系统时间已设置。");
        // 修正时区
        timeinfo.tm_hour += 8;
        mktime(&timeinfo);
        // 保存全局时间
        globalTime = mktime(&timeinfo);
    }
    // 启动定时器
    xTaskCreate(updateTimeTask, "updateTimeTask", 2048, NULL, 5, NULL);
    vTaskDelete(NULL);
}
// ininial actions

// 检查Wi-Fi连接状态，如果连接成功则获取时间
void initTime(lv_event_t * e)
{
    // 在初始化时间时把默认显示时间的label设置为主界面的, 否则label就空了
    currentTimeLabel = ui_Header_Main_Time;

    EventGroupHandle_t wifi_event_group = get_wifi_event_group();
    EventBits_t bits = xEventGroupWaitBits(wifi_event_group, WIFI_CONNECTED_BIT, false, true, portMAX_DELAY);
    if (bits & WIFI_CONNECTED_BIT) {
        ESP_LOGI("InitTime", "Wi-Fi 已连接");
        // 异步, 否则会阻塞UI线程
        xTaskCreate(obtainTime, "obtainTime", 4096, NULL, 5, NULL);
    } else {
        ESP_LOGE("InitTime", "Wi-Fi 未连接");
    }
}

// 由各个screen loaded时调用
void setTimeMain(lv_event_t * e)
{
    currentTimeLabel = ui_Header_Main_Time;
    if(globalTime > 0)
        updateCurrentTimeLabel();
}
void setTimeMusic(lv_event_t * e)
{
    currentTimeLabel = ui_Header_Music_Time;
    updateCurrentTimeLabel();
}
