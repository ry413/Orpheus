// This file was generated by SquareLine Studio
// SquareLine Studio version: SquareLine Studio 1.4.0
// LVGL version: 8.3.6
// Project name: settings

#include "ui.h"
#include "stdio.h"
#include "backlight.h"
#include "nvs.h"
#include <esp_log.h>

void decBrightness(lv_event_t * e) {
    const char *text = lv_label_get_text(ui_Backlight_Brightness_Value);
    int brightnessLevel = atoi(text);
    brightnessLevel = (brightnessLevel > 1) ? brightnessLevel - 1 : 1;
    lv_label_set_text_fmt(ui_Backlight_Brightness_Value, "%d", brightnessLevel);
    setBacklight(brightnessLevel);
}

void addBrightness(lv_event_t * e) {
    const char *text = lv_label_get_text(ui_Backlight_Brightness_Value);
    int brightnessLevel = atoi(text);
    brightnessLevel = (brightnessLevel < 5) ? brightnessLevel + 1 : 5;
    lv_label_set_text_fmt(ui_Backlight_Brightness_Value, "%d", brightnessLevel);
    setBacklight(brightnessLevel);
}

uint32_t prevBacklightLevel;
void saveBacklightBrightness(lv_event_t * e) {
    // 保存亮度等级至nvs
    nvs_handle_t nvs_handle;
    esp_err_t err = nvs_open("backlightLevel", NVS_READWRITE, &nvs_handle);
    if (err != ESP_OK) {
        ESP_LOGE("saveBacklightLevel", "Failed to open NVS");
        return;
    }
    const char *text = lv_label_get_text(ui_Backlight_Brightness_Value);
    prevBacklightLevel = atoi(text);
    err = nvs_set_u32(nvs_handle, "level", prevBacklightLevel);

    if (err != ESP_OK) {
        ESP_LOGE("saveBacklightLevel", "Failed to set backlightLevel in NVS");
        nvs_close(nvs_handle);
        return;
    }
    err = nvs_commit(nvs_handle);
    if (err != ESP_OK) {
        ESP_LOGE("saveBacklightLevel", "Failed to commit NVS changes");
    }
    nvs_close(nvs_handle);
}

void cancelSaveBacklightBrightness(lv_event_t * e) {
    lv_label_set_text_fmt(ui_Backlight_Brightness_Value, "%d", (int)prevBacklightLevel);
    setBacklight(prevBacklightLevel);
}
